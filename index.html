<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ã‚ã‚“ã“ã¨ãŠã•ã‚“ã½ ğŸ•ğŸ®</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;touch-action:none;user-select:none;-webkit-user-select:none;
  background:#1a1a2e;font-family:'DotGothic16',monospace}
#game{width:100%;display:block;image-rendering:pixelated;image-rendering:crisp-edges;background:#4a90c8}
#hud{position:fixed;top:env(safe-area-inset-top,2px);left:0;right:0;display:flex;justify-content:center;gap:6px;padding:2px 6px;z-index:5;pointer-events:none}
.hi{background:rgba(0,0,0,0.7);border:2px solid #ffd700;border-radius:6px;padding:2px 8px;color:#ffd700;font-size:12px;white-space:nowrap}
#pad{position:fixed;bottom:0;left:0;right:0;z-index:5;
  padding:8px 16px calc(env(safe-area-inset-bottom,6px) + 6px);
  background:linear-gradient(0deg,rgba(0,0,0,0.85) 0%,rgba(0,0,0,0.5) 80%,transparent);
  display:none;justify-content:space-between;align-items:flex-end}
.dp{display:grid;grid-template:"_ u _" "l c r" "_ d _"/54px 54px 54px;gap:3px}
.db{width:54px;height:54px;border-radius:12px;background:rgba(255,255,255,0.15);
  border:2px solid rgba(255,255,255,0.4);color:#fff;font-size:24px;
  display:flex;align-items:center;justify-content:center}
.db:active{background:rgba(255,255,255,0.4)}
.dc{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.1)}
.abw{display:flex;flex-direction:column;gap:10px;align-items:center}
.ab{width:72px;height:72px;border-radius:36px;border:3px solid;
  display:flex;align-items:center;justify-content:center;font-size:30px}
.ab:active{transform:scale(0.9)}
#aj{background:rgba(93,170,63,0.3);border-color:#5daa3f}
#af{background:rgba(232,86,58,0.3);border-color:#e8563a}
.abl{color:rgba(255,255,255,0.5);font-size:9px;margin-top:-2px}
#msg{position:fixed;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);
  border:2px solid #ffd700;border-radius:10px;padding:6px 16px;color:#fff;font-size:13px;
  text-align:center;z-index:6;white-space:nowrap;display:none;pointer-events:none}
/* Overlays */
.ov{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;
  justify-content:center;z-index:20;padding:16px;overflow-y:auto}
.tbg{background:linear-gradient(180deg,#2a1a4e 0%,#1a3a2e 100%)}
.rbg{background:rgba(0,0,0,0.8)}
.pt{font-size:26px;color:#ffd700;text-shadow:2px 2px 0 #8b4513,0 0 16px #ffd70060;letter-spacing:3px}
.stb{padding:14px 32px;font-size:18px;font-family:'DotGothic16',monospace;
  background:#e8563a;color:#fff;border:3px solid #fff;letter-spacing:2px;
  animation:bk 1.2s infinite}
.stb:active{transform:scale(0.95);background:#c84020}
@keyframes bk{0%,100%{opacity:1}50%{opacity:0.6}}
.cs{display:flex;gap:14px;margin-top:16px}
.co{text-align:center;padding:8px 12px;border:3px solid transparent;border-radius:10px}
.co.s{border-color:#ffd700;background:rgba(255,215,0,0.1)}
.co canvas{image-rendering:pixelated;image-rendering:crisp-edges}
.cl{color:#fff;font-size:10px;margin-top:2px}
.rc{background:rgba(255,255,255,0.08);border:3px solid #ffd700;border-radius:14px;
  padding:18px;text-align:center;max-width:340px;width:100%}
.sn{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px}
.sb{border:none;border-radius:8px;color:#fff;padding:8px;font-size:10px;font-family:'DotGothic16',monospace}
@keyframes cf{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(70vh) rotate(720deg);opacity:0}}
.cfi{position:fixed;top:-10px;font-size:20px;z-index:25;pointer-events:none}
.mu{position:fixed;top:env(safe-area-inset-top,4px);right:8px;z-index:25;background:rgba(0,0,0,0.6);
  border:2px solid #888;border-radius:8px;padding:3px 8px;color:#fff;font-size:12px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud"></div>
<div id="pad">
  <div class="dp">
    <div style="grid-area:u"><div class="db" id="du">â–²</div></div>
    <div style="grid-area:l"><div class="db" id="dl">â—€</div></div>
    <div style="grid-area:c"><div class="db dc">â—</div></div>
    <div style="grid-area:r"><div class="db" id="dr">â–¶</div></div>
    <div style="grid-area:d"><div class="db" id="dd">â–¼</div></div>
  </div>
  <div class="abw">
    <div class="ab" id="aj">â¬†</div>
    <div class="abl">ã‚¸ãƒ£ãƒ³ãƒ—</div>
    <div class="ab" id="af">ğŸ¥</div>
    <div class="abl">ãªã’ã‚‹</div>
  </div>
</div>
<div id="msg"></div>
<div id="ov"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ•ğŸ® ã‚ã‚“ã“ã¨ãŠã•ã‚“ã½ v2 â€” ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼‹ãƒ”ã‚³ãƒ”ã‚³BGM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NASU="https://www.nasuhai.co.jp/";
const CV=document.getElementById("game"),X=CV.getContext("2d");
const OV=document.getElementById("ov"),HU=document.getElementById("hud"),
      PAD=document.getElementById("pad"),MSE=document.getElementById("msg");

let W,H,GH,GY;
function resize(){
  W=window.innerWidth;
  const full=window.innerHeight;
  // ã‚²ãƒ¼ãƒ ç”»é¢ã¯ä¸Šéƒ¨58%ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é ˜åŸŸã¯ä¸‹42%
  GH=Math.floor(full*0.58);
  CV.width=W;CV.height=GH;CV.style.height=GH+"px";
  X.imageSmoothingEnabled=false;
  GY=GH*0.78; // åœ°é¢Y
}
resize();window.addEventListener("resize",resize);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â™ª ãƒ”ã‚³ãƒ”ã‚³éŸ³æ¥½ã‚¨ãƒ³ã‚¸ãƒ³ (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let actx=null,mGain=null,bgmOn=false,muOn=true;

function initA(){
  if(actx)return;
  actx=new(window.AudioContext||window.webkitAudioContext)();
  mGain=actx.createGain();mGain.gain.value=0.25;mGain.connect(actx.destination);
}
function tone(f,dur,type="square",vol=0.12,dl=0){
  if(!actx||!muOn)return;
  const o=actx.createOscillator(),g=actx.createGain();
  o.type=type;o.frequency.value=f;
  const t=actx.currentTime+dl;
  g.gain.setValueAtTime(vol,t);
  g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  o.connect(g);g.connect(mGain);o.start(t);o.stop(t+dur);
}
function noise(dur,vol=0.06){
  if(!actx||!muOn)return;
  const b=actx.createBuffer(1,actx.sampleRate*dur,actx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,3);
  const s=actx.createBufferSource();s.buffer=b;
  const g=actx.createGain();g.gain.value=vol;
  s.connect(g);g.connect(mGain);s.start();
}
// SFX
function sfxJump(){tone(440,0.07,"square",0.1);tone(660,0.07,"square",0.08,0.04);}
function sfxGet(){tone(880,0.05,"square",0.1);tone(1100,0.05,"square",0.08,0.05);tone(1320,0.07,"square",0.08,0.1);}
function sfxThrow(){tone(330,0.1,"sawtooth",0.08);tone(440,0.08,"sawtooth",0.06,0.07);}
function sfxCatch(){for(let i=0;i<4;i++)tone(660+i*110,0.07,"square",0.09,i*0.05);}
function sfxEnd(){[523,659,784,1047].forEach((n,i)=>tone(n,0.18,"square",0.1,i*0.13));}

// BGM â€” ã»ã®ã¼ã®Cãƒ¡ã‚¸ãƒ£ãƒ¼ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
const MEL=[
  [523,2],[587,2],[659,2],[523,2],[659,2],[698,2],[784,4],
  [784,2],[698,2],[659,2],[587,2],[523,2],[587,2],[523,4],
  [659,2],[659,2],[698,2],[784,2],[880,2],[784,2],[698,2],[659,2],
  [587,2],[523,2],[587,2],[659,2],[523,4],[0,4],
];
const BAS=[
  [262,4],[262,4],[349,4],[349,4],[392,4],[392,4],[262,4],[262,4],
  [349,4],[349,4],[262,4],[262,4],[392,4],[262,4],[262,4],[0,4],
];
let bgmT=null;
function startBGM(){
  if(bgmOn||!muOn)return;bgmOn=true;
  const bpm=135,bt=60/bpm;
  let mi=0,bi=0;
  function sched(){
    if(!bgmOn||!muOn)return;
    const[mf,md]=MEL[mi%MEL.length];
    if(mf>0)tone(mf,md*bt*0.8,"square",0.07);
    const[bf,bd]=BAS[bi%BAS.length];
    if(bf>0)tone(bf,bd*bt*0.9,"triangle",0.05);
    if(mi%2===0)noise(0.04,0.03);
    mi++;bi++;
    bgmT=setTimeout(sched,md*bt*1000);
  }
  sched();
}
function stopBGM(){bgmOn=false;clearTimeout(bgmT);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â—† ãƒ‰ãƒƒãƒˆçµµã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const P={_:"transparent",
  S:"#ffdbac",H:"#8b5e3c",Hb:"#e8c840",E:"#2a2a2a",M:"#c44",
  Bj:"#2255aa",Bs:"#fff",Bp:"#334",Bk:"#553322",
  Gs:"#2255aa",Gr:"#cc3344",Gk:"#223",Gw:"#fff",Gl:"#aa7744",
  Do:"#e8943a",Dw:"#fff8e0",Dk:"#2a2a2a",Db:"#c47028",Dt:"#d08030",
  Bn:"#f5f0e0",Fr:"#e83838",Fb:"#3838e8",Tr:"#4a8c28",Gn:"#6dba4f"};

const SP={
  boy_s:["____HHHHHH__","___HbHbHbHbH_","___HbHbHbHbHb","__HHHHHHHHHH_","__SSESSSESS__","__SSSSSMSSS__","___SSSSSSSS__","___BjBsBsBj__","__BjBjBsBjBj_","__BjBjBjBjBj_","___BpBpBpBp__","___BpBpBpBp__","___BkBk_BkBk_"],
  boy_w:["____HHHHHH__","___HbHbHbHbH_","___HbHbHbHbHb","__HHHHHHHHHH_","__SSESSSESS__","__SSSSSMSSS__","___SSSSSSSS__","___BjBsBsBj__","__BjBjBsBjBj_","__BjBjBjBjBj_","__BpBp__BpBp_","_BpBp____BpBp","_BkBk____BkBk"],
  girl_s:["___HHHHHHH__","__HHHHHHHHH_","__HHHHHHHHH_","_HHHHHHHHHH_","_HSSESSSESSH","_HSSSSSMSSSH","__HSSSSSSSH_","___GrGwGwGr_","__GsGsGwGsGs","__GsGsGsGsGs","___GkGkGkGk_","____SS_SS___","___GlGl_GlGl"],
  girl_w:["___HHHHHHH__","__HHHHHHHHH_","__HHHHHHHHH_","_HHHHHHHHHH_","_HSSESSSESSH","_HSSSSSMSSSH","__HSSSSSSSH_","___GrGwGwGr_","__GsGsGwGsGs","__GsGsGsGsGs","__GkGk__GkGk","_SS______SS_","GlGl____GlGl"],
  d_s:["____DoDo_____","___DoDoDo__Dt","__DoDoDoDooDt","_DkDoDkDoDoDb","_DoDoDoDoDo__","_DwDwDwDwDo__","__DwDwDwDw___","__Do_Do_Do___"],
  d_r1:["____DoDo_____","___DoDoDo_Dt_","__DoDoDoDooDt","_DkDoDkDoDoDb","_DoDoDoDoDo__","_DwDwDwDwDo__","__DwDwDwDw___","_Do___Do_____","___Do___Do___"],
  d_r2:["____DoDo_____","___DoDoDo__Dt","__DoDoDoDooDt","_DkDoDkDoDoDb","_DoDoDoDoDo__","_DwDwDwDwDo__","__DwDwDwDw___","___Do_Do_____","__Do___Do____"],
  d_j:["___DoDoDo____","__DoDoDoDo_Dt","_DoDoDoDooDtD","_DkDoDkDoDoDB","_DoDoDoDoDo__","_DwDwDwDwDo__","__DwDwDwDw___","___Do__Do____"],
};
const ITS={
  bone:["__BnBnBn__","_BnBnBnBnBn","BnBnBnBnBnBn","_BnBnBnBnBn","__BnBnBn__"],
  fris:["__FrFrFr__","_FrFbFbFrFr","FrFbFrFbFrFr","_FrFbFbFrFr","__FrFrFr__"],
  tree:["__TrTrTr__","_TrTrTrTr_","TrTrTrTrTrTr","TrGnTrTrGnTr","_TrTrTrTr_","__TrTrTr__","___BkBk___","___BkBk___","___BkBk___"],
};

function rSP(data,px){
  const pr=data.map(row=>{const p=[];let i=0;while(i<row.length){if(row[i]==="_"){p.push("_");i++;}else{let f=false;for(let l=2;l>=1;l--){const k=row.substr(i,l);if(P[k]!==undefined){p.push(k);i+=l;f=true;break;}}if(!f){p.push("_");i++;}}}return p;});
  const mw=Math.max(...pr.map(r=>r.length)),cv=document.createElement("canvas");
  cv.width=mw*px;cv.height=pr.length*px;
  const c=cv.getContext("2d");
  pr.forEach((row,y)=>row.forEach((k,x)=>{if(k!=="_"&&P[k]&&P[k]!=="transparent"){c.fillStyle=P[k];c.fillRect(x*px,y*px,px,px);}}));
  return cv;
}
const PX=4,sc={};
function initSP(){Object.entries(SP).forEach(([k,v])=>{sc[k]=rSP(v,PX);});Object.entries(ITS).forEach(([k,v])=>{sc[k]=rSP(v,PX);});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â—† ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let st="title",ct="boy",score=0,bones=0,timer=60,t0=0,combo=0,mxC=0,mood=80;
let fOn=false,fri={x:0,y:0,vx:0,vy:0,ld:false};
let mt="",mT=0,fc=0,cx=0;
let pl={x:0,y:0,vx:0,vy:0,dr:1,jp:false};
let dg={x:0,y:0,vx:0,vy:0,st:"follow",jp:false,has:false};
let its=[],pt=[],cld=[],tre=[];
let K={l:false,r:false,u:false};

function initW(){
  pl={x:W*0.3,y:GY,vx:0,vy:0,dr:1,jp:false};
  dg={x:pl.x-50,y:GY,vx:0,vy:0,st:"follow",jp:false,has:false};
  its=[];pt=[];score=0;bones=0;timer=60;combo=0;mxC=0;mood=80;fOn=false;cx=0;
  cld=Array.from({length:6},()=>({x:Math.random()*W*3,y:10+Math.random()*(GY*0.25),w:30+Math.random()*40,sp:0.15+Math.random()*0.25}));
  tre=Array.from({length:15},(_,i)=>({x:120+i*(130+Math.random()*80)}));
  for(let i=0;i<25;i++)its.push({x:200+i*(90+Math.random()*60),y:GY-6-Math.random()*30,got:false});
}

// â”€â”€ Input â”€â”€
document.addEventListener("keydown",e=>{if(e.key==="ArrowLeft"||e.key==="a")K.l=true;if(e.key==="ArrowRight"||e.key==="d")K.r=true;if(e.key==="ArrowUp"||e.key==="w"||e.key===" ")K.u=true;if(e.key==="z"||e.key==="Enter")doTh();});
document.addEventListener("keyup",e=>{if(e.key==="ArrowLeft"||e.key==="a")K.l=false;if(e.key==="ArrowRight"||e.key==="d")K.r=false;if(e.key==="ArrowUp"||e.key==="w"||e.key===" ")K.u=false;});

function bT(id,k){
  const e=document.getElementById(id);if(!e)return;
  const on=ev=>{ev.preventDefault();K[k]=true;};
  const off=()=>{K[k]=false;};
  e.addEventListener("pointerdown",on);e.addEventListener("pointerup",off);
  e.addEventListener("pointerleave",off);e.addEventListener("pointercancel",off);
}
function setupCtrl(){
  bT("dl","l");bT("dr","r");bT("du","u");
  const j=document.getElementById("aj");
  if(j){const on=e=>{e.preventDefault();K.u=true;},off=()=>{K.u=false;};
    j.addEventListener("pointerdown",on);j.addEventListener("pointerup",off);
    j.addEventListener("pointerleave",off);j.addEventListener("pointercancel",off);}
  document.getElementById("af")?.addEventListener("pointerdown",e=>{e.preventDefault();doTh();});
}
function showM(t){mt=t;mT=90;MSE.textContent=t;MSE.style.display="block";MSE.style.bottom=(window.innerHeight-GH+8)+"px";}
function spP(x,y,em){pt.push({x,y,vx:(Math.random()-0.5)*2.5,vy:-1.5-Math.random()*1.5,l:30,em});}

function doTh(){
  if(fOn||st!=="playing")return;
  fOn=true;fri={x:pl.x+pl.dr*18,y:pl.y-24,vx:pl.dr*5,vy:-3,ld:false};
  dg.st="fetch";dg.has=false;sfxThrow();showM("ã„ã‘ã£ï¼ğŸ¥");
}

// â”€â”€ Update â”€â”€
function update(){
  if(st!=="playing")return;fc++;
  timer=Math.max(0,60-(Date.now()-t0)/1000);
  if(timer<=0){endG();return;}

  if(K.l){pl.vx=-2.8;pl.dr=-1;}else if(K.r){pl.vx=2.8;pl.dr=1;}else pl.vx*=0.7;
  if(K.u&&!pl.jp){pl.vy=-6.5;pl.jp=true;sfxJump();}
  pl.x+=pl.vx;pl.vy+=0.4;pl.y+=pl.vy;
  if(pl.y>=GY){pl.y=GY;pl.vy=0;pl.jp=false;}
  if(pl.x<16)pl.x=16;
  cx+=(pl.x-W*0.3-cx)*0.08;if(cx<0)cx=0;

  if(fOn&&!fri.ld){fri.x+=fri.vx;fri.vy+=0.16;fri.y+=fri.vy;if(fri.y>=GY-4){fri.y=GY-4;fri.ld=true;fri.vx=0;fri.vy=0;}}

  // Dog AI
  const sp=3;
  if(dg.st==="follow"){
    const tx=pl.x-pl.dr*38,dx=tx-dg.x;
    dg.vx=Math.abs(dx)>8?Math.sign(dx)*Math.min(sp,Math.abs(dx)*0.1):dg.vx*0.8;
    if(Math.random()<0.005&&!dg.jp){dg.vy=-5;dg.jp=true;}
  }else if(dg.st==="fetch"){
    const tx=fri.ld?fri.x:fri.x+fri.vx*10;
    if(fri.ld&&Math.abs(dg.x-fri.x)<14){
      dg.has=true;fOn=false;dg.st="return";score+=50;combo++;if(combo>mxC)mxC=combo;
      mood=Math.min(100,mood+15);spP(dg.x,dg.y-16,"ğŸ‰");spP(dg.x,dg.y-16,"ğŸ’•");
      sfxCatch();showM("ã‚­ãƒ£ãƒƒãƒï¼ã‹ã—ã“ã„ï¼ğŸ•âœ¨");
      if(!dg.jp){dg.vy=-5.5;dg.jp=true;}
    }else dg.vx=Math.sign(tx-dg.x)*sp*1.3;
  }else if(dg.st==="return"){
    if(Math.abs(pl.x-dg.x)<28){dg.has=false;dg.st="follow";score+=30;spP(dg.x,dg.y-16,"â¤ï¸");mood=Math.min(100,mood+10);showM("ã„ã„å­ï¼ğŸ’•");}
    else dg.vx=Math.sign(pl.x-dg.x)*sp*1.1;
  }
  dg.x+=dg.vx;dg.vy+=0.4;dg.y+=dg.vy;
  if(dg.y>=GY){dg.y=GY;dg.vy=0;dg.jp=false;}

  its.forEach(it=>{
    if(it.got)return;
    if(Math.abs(pl.x-it.x)<22&&Math.abs(pl.y-it.y)<22){
      it.got=true;bones++;score+=10*(1+Math.floor(combo/3));combo++;if(combo>mxC)mxC=combo;
      spP(it.x,it.y,"ğŸ¦´");spP(it.x,it.y,"âœ¨");sfxGet();
      if(combo>=3&&combo%3===0)showM(combo+"ã‚³ãƒ³ãƒœï¼ğŸ”¥");
    }
  });
  pt.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.08;p.l--;});
  pt=pt.filter(p=>p.l>0);
  cld.forEach(c=>{c.x-=c.sp;if(c.x+c.w<cx-40)c.x=cx+W+40;});
  if(fc%60===0){const d=Math.abs(pl.x-dg.x);if(d<70)mood=Math.min(100,mood+2);else if(d>180)mood=Math.max(0,mood-1);}
  if(mT>0)mT--;if(mT<=0)MSE.style.display="none";
}

// â”€â”€ Draw â”€â”€
function draw(){
  X.clearRect(0,0,W,GH);
  const sky=X.createLinearGradient(0,0,0,GY);
  sky.addColorStop(0,"#4a90c8");sky.addColorStop(0.7,"#88c8e8");sky.addColorStop(1,"#b8e8b0");
  X.fillStyle=sky;X.fillRect(0,0,W,GY+2);
  X.fillStyle="#5daa3f";X.fillRect(0,GY,W,GH-GY);
  X.fillStyle="#4a9030";X.fillRect(0,GY,W,3);

  X.fillStyle="rgba(255,255,255,0.6)";
  cld.forEach(c=>{const sx=c.x-cx*0.3;if(sx>-c.w&&sx<W+c.w){X.beginPath();X.arc(sx,c.y,c.w*0.28,0,Math.PI*2);X.arc(sx+c.w*0.25,c.y-3,c.w*0.22,0,Math.PI*2);X.arc(sx+c.w*0.45,c.y,c.w*0.18,0,Math.PI*2);X.fill();}});

  tre.forEach(t=>{const sx=t.x-cx;if(sx>-50&&sx<W+50&&sc.tree)X.drawImage(sc.tree,sx-16,GY-sc.tree.height);});

  X.fillStyle="#6dba4f";
  for(let x=-cx%22;x<W;x+=22){const h=2+Math.sin(x*0.8)*1.5;X.fillRect(x,GY-h,2,h);}

  its.forEach(it=>{if(it.got)return;const sx=it.x-cx;if(sx>-16&&sx<W+16&&sc.bone){const b=Math.sin(fc*0.08+it.x)*2.5;X.drawImage(sc.bone,sx-10,it.y-10+b);}});

  if(fOn&&sc.fris){X.save();X.translate(fri.x-cx,fri.y);X.rotate(fc*0.2);X.drawImage(sc.fris,-10,-10);X.restore();}

  drawC(dg,true);drawC(pl,false);

  X.textAlign="center";
  pt.forEach(p=>{X.globalAlpha=p.l/30;X.font="13px sans-serif";X.fillText(p.em,p.x-cx,p.y);});
  X.globalAlpha=1;
}

function drawC(o,isD){
  const sx=o.x-cx,mv=Math.abs(o.vx)>0.4,dr=isD?(o.vx>=0?1:-1):o.dr;
  let k;
  if(isD){k=mv?(fc%12<6?"d_r1":"d_r2"):(o.jp?"d_j":"d_s");}
  else{const c=ct==="boy"?"boy":"girl";k=mv?(fc%14<7?c+"_w":c+"_s"):c+"_s";}
  const s=sc[k];if(!s)return;
  X.save();X.translate(sx,o.y-s.height+3);
  if(dr<0){X.scale(-1,1);X.translate(-s.width,0);}
  X.drawImage(s,0,0);X.restore();
  if(isD&&o.has){X.font="11px sans-serif";X.textAlign="center";X.fillText("ğŸ¥",sx,o.y-s.height-3);}
  if(isD&&mood>75&&fc%40<18){X.font="9px sans-serif";X.fillText("â™¡",sx+8,o.y-s.height-5);}
  X.fillStyle="rgba(0,0,0,0.1)";X.beginPath();X.ellipse(sx+4,GY+1,isD?10:12,2.5,0,0,Math.PI*2);X.fill();
}

function updHUD(){
  const me=mood>70?"ğŸ˜Š":mood>40?"ğŸ˜":"ğŸ˜¢";
  HU.innerHTML=`<div class="hi">â±${Math.ceil(timer)}</div><div class="hi">ğŸ¦´${bones}</div><div class="hi">â­${score}</div><div class="hi">${me}${Math.floor(mood)}</div>`;
}

// â”€â”€ End â”€â”€
function endG(){
  st="result";stopBGM();sfxEnd();PAD.style.display="none";HU.innerHTML="";MSE.style.display="none";
  const ms=["ãŸã®ã—ã‹ã£ãŸï¼ğŸ¾","ã„ã£ã±ã„èµ°ã‚ŒãŸï¼ğŸ¦®","ãƒ•ãƒªã‚¹ãƒ“ãƒ¼æ¥½ã—ã„ï¼ğŸ¥","ãŠã‚„ã¤ã¾ã ï¼ŸğŸ–","ä¸€ç·’ãŒã„ã¡ã°ã‚“ğŸ’•"];
  const rm=ms[Math.floor(Math.random()*ms.length)];
  const rk=score>=500?"S":score>=300?"A":score>=150?"B":"C";
  const rc={S:"#ffd700",A:"#e8563a",B:"#4ca8c8",C:"#888"}[rk];
  const cf=Array.from({length:10},()=>`<div class="cfi" style="left:${5+Math.random()*90}%;animation:cf ${2+Math.random()*2}s ease-in ${Math.random()*1.2}s forwards">${["ğŸ‰","âœ¨","ğŸ¾","â­","ğŸ¦´","ğŸ’›"][Math.floor(Math.random()*6)]}</div>`).join("");
  OV.innerHTML=`${cf}<div class="ov rbg"><div class="rc">
    <div style="font-size:36px">ğŸ‰</div><div style="font-size:16px;color:#ffd700">ãŠã•ã‚“ã½çµ‚äº†ï¼</div>
    <div style="font-size:40px;color:#ffd700;margin:4px 0">â­${score}</div>
    <div style="font-size:36px;color:${rc}">RANK ${rk}</div>
    <div style="display:flex;justify-content:center;gap:10px;color:#ccc;font-size:11px;margin:6px 0">
      <span>ğŸ¦´${bones}</span><span>ğŸ”¥æœ€å¤§${mxC}</span><span>ğŸ˜Š${Math.floor(mood)}</span></div>
    <div style="background:rgba(255,215,0,0.1);border:2px solid #ffd700;border-radius:8px;padding:8px;margin:8px 0">
      <div style="font-size:9px;color:#ffd700">ğŸ’Œ ã‚ã‚“ã“ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div style="color:#8cd860;font-size:13px;line-height:1.8;margin-top:4px">${rm}</div></div>
    <div style="font-size:10px;color:#ccc">ğŸ“¢ ã‚·ã‚§ã‚¢</div>
    <div class="sn">
      <button class="sb" style="background:#000" onclick="shr('x')">ğ•</button>
      <button class="sb" style="background:#06C755" onclick="shr('li')">LINE</button>
      <button class="sb" style="background:#1877f2" onclick="shr('fb')">FB</button>
      <button class="sb" style="background:linear-gradient(45deg,#f09433,#dc2743)" onclick="shr('ig')">Insta</button></div>
    <div style="display:flex;gap:6px;margin-top:10px">
      <button class="stb" style="flex:1;animation:none;font-size:13px;padding:10px" id="rr">ğŸ”„ ã‚‚ã†1å›</button>
      <button class="stb" style="flex:1;animation:none;font-size:13px;padding:10px;background:#2255aa" id="rh">ğŸ  ãƒˆãƒƒãƒ—</button>
    </div></div></div>`;
  document.getElementById("rr")?.addEventListener("click",startG);
  document.getElementById("rh")?.addEventListener("click",()=>{st="title";showT();});
}
window.shr=function(p){
  const t=`ğŸ•ğŸ® ã‚ã‚“ã“ã¨ãŠã•ã‚“ã½\nã‚¹ã‚³ã‚¢${score}ç‚¹ RANK${score>=500?"S":score>=300?"A":score>=150?"B":"C"}\nğŸ¦´${bones}å€‹ ğŸ”¥${mxC}ã‚³ãƒ³ãƒœ\n#ã‚ã‚“ã“ã¯ã‹ãã #é‚£é ˆãƒã‚¤ãƒ©ãƒ³ãƒ‰ãƒ‘ãƒ¼ã‚¯`;
  const e=encodeURIComponent(t),u=encodeURIComponent(NASU);
  if(p==="x")window.open("https://x.com/intent/tweet?text="+e+"&url="+u,"_blank");
  else if(p==="li")window.open("https://social-plugins.line.me/lineit/share?url="+u+"&text="+e,"_blank");
  else if(p==="fb")window.open("https://www.facebook.com/sharer/sharer.php?u="+u+"&quote="+e,"_blank");
  else{try{navigator.clipboard.writeText(t+"\n"+NASU);}catch(x){}alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");}
};

// â”€â”€ Title â”€â”€
function showT(){
  PAD.style.display="none";HU.innerHTML="";MSE.style.display="none";
  const bp=sc.boy_s,gp=sc.girl_s,dp=sc.d_s;
  OV.innerHTML=`
    <div class="ov tbg">
      <div style="font-size:42px;margin-bottom:2px">ğŸ•ğŸ®</div>
      <div class="pt">ã‚ã‚“ã“ã¨ãŠã•ã‚“ã½</div>
      <div style="font-size:12px;color:#8cd860;margin-top:4px">ãƒ¬ãƒˆãƒ­ãƒ‰ãƒƒãƒˆçµµã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</div>
      <div style="color:#aaa;font-size:10px;margin-top:14px">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­</div>
      <div class="cs">
        <div class="co${ct==="boy"?" s":""}" id="sb">
          <canvas id="pb" width="${bp?.width||48}" height="${bp?.height||52}" style="width:${(bp?.width||48)*1.5}px;height:${(bp?.height||52)*1.5}px"></canvas>
          <div class="cl">ãŠã«ã„ã¡ã‚ƒã‚“</div></div>
        <div class="co${ct==="girl"?" s":""}" id="sg">
          <canvas id="ppg" width="${gp?.width||48}" height="${gp?.height||52}" style="width:${(gp?.width||48)*1.5}px;height:${(gp?.height||52)*1.5}px"></canvas>
          <div class="cl">ãŠã­ãˆã¡ã‚ƒã‚“</div></div>
      </div>
      <div style="margin-top:10px">
        <canvas id="pd" width="${dp?.width||52}" height="${dp?.height||32}" style="width:${(dp?.width||52)*2}px;height:${(dp?.height||32)*2}px"></canvas></div>
      <button class="stb" id="go">â–¶ ã¯ã˜ã‚ã‚‹</button>
      <div style="color:#888;font-size:10px;line-height:2;margin-top:10px;text-align:center">
        â—€â–¶ ç§»å‹• ï½œ â¬† ã‚¸ãƒ£ãƒ³ãƒ— ï½œ ğŸ¥ ãƒ•ãƒªã‚¹ãƒ“ãƒ¼<br>
        60ç§’ã§ğŸ¦´ã‚’é›†ã‚ã¦éŠã¼ã†ï¼</div>
      <button class="mu" id="mu">${muOn?"ğŸ”Š ON":"ğŸ”‡ OFF"}</button>
      <div style="margin-top:8px"><a href="${NASU}" target="_blank" style="font-size:10px;color:#666;text-decoration:none">ğŸ”ï¸ é‚£é ˆãƒã‚¤ãƒ©ãƒ³ãƒ‰ãƒ‘ãƒ¼ã‚¯ â†’</a></div>
    </div>`;
  setTimeout(()=>{
    const bc=document.getElementById("pb");if(bc&&bp)bc.getContext("2d").drawImage(bp,0,0);
    const gc=document.getElementById("ppg");if(gc&&gp)gc.getContext("2d").drawImage(gp,0,0);
    const dc=document.getElementById("pd");if(dc&&dp)dc.getContext("2d").drawImage(dp,0,0);
    document.getElementById("sb")?.addEventListener("click",()=>{ct="boy";showT();});
    document.getElementById("sg")?.addEventListener("click",()=>{ct="girl";showT();});
    document.getElementById("go")?.addEventListener("click",startG);
    document.getElementById("mu")?.addEventListener("click",()=>{muOn=!muOn;if(!muOn)stopBGM();showT();});
  },50);
}

function startG(){
  initA();st="playing";OV.innerHTML="";resize();initW();t0=Date.now();fc=0;
  PAD.style.display="flex";setupCtrl();updHUD();showM("ãŠã•ã‚“ã½ã‚¹ã‚¿ãƒ¼ãƒˆï¼ğŸ¦´ã‚’é›†ã‚ã‚ˆã†ï¼");startBGM();
}

// â”€â”€ Main Loop â”€â”€
function loop(){if(st==="playing"){update();draw();if(fc%8===0)updHUD();}requestAnimationFrame(loop);}
initSP();showT();loop();
</script>
</body>
</html>
